apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-config-info
  namespace: {{ cos_running_namespaces }}
data:
  cluster: |
    clusterName: "{{ cluster_identity_name }}"
    clusterDnsDomain: "{{ cluster_name }}"
    endpointIP: "{{ cluster_vip }}"
    endpointPort: "{{ kube_apiserver_port }}"
    kubeconfig:
      apiVersion: "{{ kubeConfigFile['ansible_facts']['apiVersion'] }}"
      clusters:
      - cluster:
          certificate-authority-data: {{ kubeConfigFile['ansible_facts']['clusters'][0]['cluster']['certificate-authority-data'] }}
          server: {{ kubeConfigFile['ansible_facts']['clusters'][0]['cluster']['server'] }}
        name: {{ kubeConfigFile['ansible_facts']['clusters'][0]['name'] }}
      contexts:
      - context:
          cluster: {{ kubeConfigFile['ansible_facts']['contexts'][0]['context']['cluster'] }}
          user: {{ kubeConfigFile['ansible_facts']['contexts'][0]['context']['user'] }}
        name: {{ kubeConfigFile['ansible_facts']['contexts'][0]['name'] }}
      current-context: {{ kubeConfigFile['ansible_facts']['current-context'] }}
      kind: {{ kubeConfigFile['ansible_facts']['kind'] }}
      preferences: {{ kubeConfigFile['ansible_facts']['preferences'] }}
      users:
      - name: {{ kubeConfigFile['ansible_facts']['users'][0]['name'] }}
        user:
          client-certificate-data: {{ kubeConfigFile['ansible_facts']['users'][0]['user']['client-certificate-data'] }}
          client-key-data: {{ kubeConfigFile['ansible_facts']['users'][0]['user']['client-key-data'] }}
{% if is_control_cluster %}
    isControlCluster: true
{% else %}
    isControlCluster: false
{% endif %}
{% if groups['kube-master'] | length > 1 %}
    isHighAvailable: true
{% else %}
    isHighAvailable: false
{% endif %}
    clusterSets:
      k8s_custom: false
    kubeServiceAddresses: "{{ kube_service_addresses }}"
    kubePodsSubnet: "{{ kube_pods_subnet }}"
{% if enable_nodelocaldns %}
{% set kubelet_cluster_dns = [nodelocaldns_ip] %}
{% elif dns_mode in ['coredns'] %}
{% set kubelet_cluster_dns = [skydns_server] %}
{% elif dns_mode == 'coredns_dual' %}
{% set kubelet_cluster_dns = [skydns_server,skydns_server_secondary] %}
{% elif dns_mode == 'manual' %}
{% set kubelet_cluster_dns = [manual_dns_server] %}
{% else %}
{% set kubelet_cluster_dns = [] %}
{% endif %}
  kubeletClusterDns: |
{% for dns_address in kubelet_cluster_dns %}
    - "{{ dns_address }}"
{% endfor %}
  machine: |
{% for hostname in ansible_play_hosts %}
    {{ hostname }}:
      address: {{ hostvars[hostname]['ansible_host'] }}
      auth:
        key: "ssh-login-config"
        user: {{ hostvars[hostname]['ansible_user'] }}
        port: {{ ansible_port }}
      isEtcd: {{ hostname in groups['etcd'] | lower }}
      isMaster: {{ hostname in groups['kube-master'] | lower }}
{% endfor %}
